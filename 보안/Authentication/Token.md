# **1. 토큰 기반 인증이란?**

- 인증 받은 사용자들에게 토큰을 발급, 서버에 요청 할 때 토큰을 함께 보내 유효성 검사를한다.
- 사용자의 인증정보를 서버나 세션에 유지하지 않고 클라이언트 측에서 들어오는 요청만으로 작업을 처리함
- 서버기반의 인증시스템과 달리 Stateless한 구조를 가짐
- 트래픽을 감당하기 위하여 여러개의 프로세스를 돌리거나 여러대의 서버 컴퓨터를 추가하지 않아도되기 떄문에 확장성이 높음

---

# **2. 인증과정**

1. 사용자 로그인 요청
2. 서버 -> 회원 확인
3. 계정정보가 정확하다면 유저에게 Access(+Refresh) Token 발급<br>
   -> 토큰에는 유효기간을 설정해야하며, 인증에 필요한 정보를 암호화하여 토큰발급(JWT)
4. 로그인 요청에 대한 응답과 함께 토큰을 클라이언트에게 보냅니다.
5. 클라이언트 측에서는 토큰을 저장해두고 서버에게 요청할 때 함께 전송
6. 서버는 해당 토큰을 복호화한후 유효한 토큰인지 검증
7. 검증에 성공하면, 해당 사용자에 맞는 데이터 응답
8. 토큰만료(검증실패)시 클라이언트에 실패응답 및 Refresh Token 요청
9. Refresh Token 검증후<br>
   만료: 클라이언트에 실패 및 재로그인 요청 응답<br>
   유효: Access Token 재발급후 클라이언트에 전달

<img src="https://s3.us-west-2.amazonaws.com/secure.notion-static.com/6bc2e007-9893-46e4-9b6b-2c7fa7fbe143/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAT73L2G45O3KS52Y5%2F20211024%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20211024T140033Z&X-Amz-Expires=86400&X-Amz-Signature=2ab8049475eef2cff41ee9914be7e1791032250e940d7409f809344be35ac473&X-Amz-SignedHeaders=host&response-content-disposition=filename%20%3D%22Untitled.png%22" width="400" height="300"></img>

---

# **3. 장단점**

## **1. 장점**

1. Stateless 서버<br>
   : 세선/쿠키 인증방식은 서버에서 별도의 세션 저장소에 클라이언트 상태를 계속 유지하고 이 정보를 서비스에 이용하는 Stateful 서버였음. 하지만 토큰에는 인증에 필요한 모든 정보를 담고 있으므로, 서버에 별도의 세션저장소가 필요하지 않으며 서버는 클라이언트측에서 들어오는 요청으로만 작업을 처리

2. 높은 서버 확장성<br>
   : 토큰 기반 인증은 Stateless 서버, 즉 클라이언트와 서버와의 연결고리가 없기때문에 서버의 확장성이 좋아짐. 여기서 말하는 서버의 확장성이란 많은 트래픽을 감당하기 위하여 여러개의 프로세스를 돌리거나 여러대의 서버 컴퓨터를 추가 하는것을 의미함

3. 확장성(Extensibility)<br>
   : 여기서의 확장성은 로그인 분야의 확장되는 것을 의미함. 토큰을 사용하여 다른 서비스에서도 권한을 공유할 수 있음. 대표적인 예제로 OAuth, 이를 통해 페이스북/구글/네이버 계정을 이용하여 다른 웹서비스에 로그인할 수 있음

---

## **2. 단점**

1. 이미 발급된 토큰에대해서는 돌이킬 수 없음.<br>
   : 세션/쿠키 방식에서는 서버가 클라이언트의 세션을 삭제시켜 강제 로그아웃이 가능했지만, 토큰은 한번 발급되게되면 유효기간이 지날때까지 계속 사용이 가능함.<br>
   -> 서버에서 토큰을 제어할 수 없음<br>
   -> Access Token의 유효기간을 짧게하고 Refresh Token이라는 새로운 토큰을 발급하면 해결 가능<br>

---

# **4. Json Web Token(JWT)**

- 토큰 기반 인증 중 가장 많이 사용 되고 있음
- 인증 정보를 담고있는 JSON 객체를 암호화시켜 인증 정보를 안전하게 전송함
- 이떄 암호화는 비밀키(HAMC) 혹은 공개키,개인키쌍(RSA)를 사용

## **1. 구조**

- Header: 토큰의 타입이 JWT라는 것과 어떤 해싱알고리즘(HMAC, RSA)를 사용했는지 담겨있음
- Payload: 사용자의 인증정보가 담겨있음
- Signature: 전자서명, 헤더에서 명시한 해싱을 통해 생성됨

---

# **5. 토큰 저장 위치**

## **1. LocalStroage**

### 1. 장점

- CSRF 공격에 안전
- 자동으로 request에 담기는 쿠키와 다르게 js 코드에 의해 헤더에 담기기 떄문에 XSS를 뚫지 않는 이상,<br>
  공격자가 request를 보내기가 어려움

### 2. 단점

- XSS에 취약함
- 공격자가 localStorage에 접근하는 Js코드 한줄만 주입하면 localStorage를 공격자가 쉽게 드나들 수 있음

## **2. Cookie**

### 1. 장점

- XSS 공격으로부터 LocalStroage에 비해 비교적 안전함
- httpOnly 옵션을 통해 js에서 쿠키에 접근자체가 불가능함
- _사용자의 컴퓨터에서 요청을 위조가능하기 때문에 완전히 안전한것은 아님_

### 2. 단점

- CSRF 공격에 취약하다.
- 자동으로 http request에 담아서 보내기 때문에 공격자가 request url만 안다면,<br>
  사용자가 관련 link를 클릭하도록 유도하여 request를 위조하기 쉬움

---

# **6. Refresh Token**

- 위의 단점들을 보완하기 위해 사용
- Access Token의 유효기간을 짧게 설정하여 일정 시간마다 토큰을 재발급 해줌
- refresh token이 CSRF에 의해 사용된다 하더라도 공격자는 accessToken을 알 수 없음
- 쿠키를 사용하여 XSS를 막고 refresh token 방식을 이용하여 CSRF를 막을 수 있는 방법
